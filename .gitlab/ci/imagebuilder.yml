build-imagebuilder_x86-64:
  extends: .build
  variables:
    TARGET: "x86-64"
    DOCKER_IMAGE: "$CI_REGISTRY_IMAGE"
  script: |
    bash docker-imagebuilder.sh
    docker tag "$DOCKER_IMAGE:$TARGET-$VERSION" \
      "$DOCKER_IMAGE:imagebuilder-$TARGET-$VERSION-$CI_COMMIT_REF_SLUG"
    docker push "$DOCKER_IMAGE:imagebuilder-$TARGET-$VERSION-$CI_COMMIT_REF_SLUG"

test-imagebuilder:
  image: "$CI_REGISTRY_IMAGE:imagebuilder-x86-64-$VERSION-$CI_COMMIT_REF_SLUG"
  stage: test
  script:
    - cd /home/build/openwrt/
    - make image
    - ls ./bin/targets/x86/64/*.img.gz | grep squashfs
